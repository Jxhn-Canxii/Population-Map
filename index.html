<!DOCTYPE html>
<html>
<head>
    <title>Philippine Barangay Population Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        #map { height: 100vh; }
        .legend { padding: 10px; background: white; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
        /*custom popup styling */
        .leaflet-popup-content h3 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
        }
        
        .leaflet-popup-content p {
            margin: 5px 0;
        }
        
        .leaflet-popup-content small {
            color: #666;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Core Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Marker Cluster Plugin -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // Initialize map centered on Philippines
        loadMap();

        async function fetchPopulationData() {
            try {
                const response = await fetch('https://example.com/api/barangays'); // Replace with actual API URL
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching population data:', error);
                return [];
            }
        }

        async function loadMap() {
            const map = L.map('map').setView([12.8797, 121.7740], 6);

            // Add base tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            // use this format if you want to use server side query
            // Fetch barangay data from the server
            ///const barangays = await fetchPopulationData();

            // Sample barangay data (replace with real coordinates) remove this const barangays 
            // and replace with the server side barangay variable if you want to use serverside data
            const barangays = [
                {
                    name: "Brgy. 1, Manila",
                    population: 15000,
                    coordinates: [14.5995, 120.9842]
                },
                {
                    name: "Brgy. 2, Cebu",
                    population: 8000,
                    coordinates: [10.3157, 123.8854]
                },
                {
                    name: "Brgy. 3, Davao",
                    population: 4000,
                    coordinates: [7.1907, 125.4553]
                }
            ];

            // Create marker cluster group
            const markers = L.markerClusterGroup({
                showCoverageOnHover: false,
                maxClusterRadius: 60
            });

            // Add markers with custom icons and click handlers
            barangays.forEach(barangay => {
                const marker = L.marker(barangay.coordinates, {
                    icon: new L.Icon({
                        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${getMarkerColor(barangay.population)}.png`,
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).bindPopup(`
                    <div class="popup-content">
                        <h3>${barangay.name}</h3>
                        <p><strong>Population:</strong> ${barangay.population.toLocaleString()}</p>
                        <p><strong>Coordinates:</strong><br>
                        Lat: ${barangay.coordinates[0].toFixed(4)}<br>
                        Lng: ${barangay.coordinates[1].toFixed(4)}</p>
                    </div>
                `);

                // Add click event listener for additional actions
                marker.on('click', function(e) {
                    // You can add more interactions here
                    console.log('Marker clicked:', barangay);
                    this.openPopup();
                    
                    // Example: Zoom to marker
                    map.setView(e.latlng, 15);
                });

                markers.addLayer(marker);
            });

            map.addLayer(markers);

            // Color coding function
            function getMarkerColor(population) {
                return population > 10000 ? 'red' :
                    population > 7000 ? 'orange' :
                    population > 4000 ? 'gold' :
                    population > 2000 ? 'green' :
                                        'blue';
            }

            // Add legend
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = () => {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `
                    <h4>Population Legend</h4>
                    <div><img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png" width="20"> &lt; 2,000</div>
                    <div><img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png" width="20"> 2,000-4,000</div>
                    <div><img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png" width="20"> 4,000-7,000</div>
                    <div><img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png" width="20"> 7,000-10,000</div>
                    <div><img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png" width="20"> &gt; 10,000</div>
                `;
                return div;
            };
            legend.addTo(map);
        }
    </script>
</body>
</html>